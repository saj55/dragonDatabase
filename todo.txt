Change mainLoop into a session class
